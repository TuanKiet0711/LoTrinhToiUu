@{
    ViewData["Title"] = "Bản đồ tham quan (xe du lịch)";
}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  #map { height: 78vh; border-radius: 12px; }
  .toolbar { margin:10px 0; display:flex; gap:8px; flex-wrap:wrap; }
  .chip { padding:8px 12px; border:1px solid #ddd; border-radius:999px; cursor:pointer; }
  .chip.primary { background:#f3f4f6; }
</style>

<h2>@ViewData["Title"]</h2>
<div class="toolbar">
  <button class="chip" id="btnUseMyLoc">Lấy vị trí hiện tại làm điểm xuất phát</button>
  <button class="chip" id="btnAddPOI">Thêm nhanh các điểm nổi tiếng Q1</button>
  <button class="chip primary" id="btnRoute">Tính đường XE DU LỊCH</button>
  <button class="chip" id="btnClear">Xoá tuyến</button>
</div>
<div id="map"></div>
<div id="steps"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const map = L.map('map').setView([10.776889,106.700806], 14);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
              {maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(map);

  let routeLayer = null;
  const markers = [];
  const coords = []; // [[lng,lat],...]

  function addMarker(lat, lng, label) {
    const m = L.marker([lat,lng]).addTo(map).bindPopup(label || "Điểm");
    markers.push(m);
  }
  function addCoord(lng, lat) {
    coords.push([lng,lat]);
  }

  // Click trên bản đồ để thêm điểm
  map.on('click', (e) => {
    addCoord(e.latlng.lng, e.latlng.lat);
    addMarker(e.latlng.lat, e.latlng.lng, `Điểm ${coords.length}`);
  });

  // Lấy vị trí người dùng làm điểm đầu
  document.getElementById('btnUseMyLoc').onclick = () => {
    if (!navigator.geolocation) return alert("Trình duyệt không hỗ trợ định vị.");
    navigator.geolocation.getCurrentPosition(pos => {
      const { latitude, longitude } = pos.coords;
      coords.unshift([longitude, latitude]); // origin ở đầu
      addMarker(latitude, longitude, "Xuất phát");
      map.setView([latitude, longitude], 15);
    }, () => alert("Không lấy được vị trí."));
  };

  // Thêm nhanh vài POI trung tâm Q1 (bạn có thể sửa danh sách này)
  document.getElementById('btnAddPOI').onclick = () => {
    const poi = [
      { name:"Nhà thờ Đức Bà",   lat:10.779783, lng:106.699009 },
      { name:"Bưu điện Trung tâm",lat:10.779315, lng:106.699651 },
      { name:"Dinh Độc Lập",     lat:10.777266, lng:106.695722 },
      { name:"Bến Bạch Đằng",    lat:10.773918, lng:106.708641 }
    ];
    poi.forEach(p => { addCoord(p.lng, p.lat); addMarker(p.lat, p.lng, p.name); });
    alert("Đã thêm 4 điểm nổi tiếng Q1. Giữ đúng thứ tự hiện tại.");
  };

  document.getElementById('btnClear').onclick = () => {
    coords.length = 0;
    markers.forEach(m => map.removeLayer(m));
    markers.length = 0;
    if (routeLayer) { map.removeLayer(routeLayer); routeLayer = null; }
    document.getElementById('steps').innerHTML = "";
  };

  document.getElementById('btnRoute').onclick = async () => {
    if (coords.length < 2) return alert("Chọn ít nhất 2 điểm (xuất phát và đích).");

    const res = await fetch('/api/coach-route', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({
        coords,
        vehicle: { weightTons: 15, height: 3.5, width: 2.5, length: 12 } // tuỳ xe
      })
    });
    if (!res.ok) {
      const txt = await res.text();
      alert("Không tính được tuyến:\n" + txt);
      return;
    }
    const data = await res.json();
    const feat = data?.features?.[0];
    if (!feat) return alert("Không có kết quả.");

    if (routeLayer) map.removeLayer(routeLayer);
    routeLayer = L.geoJSON(feat.geometry).addTo(map);
    map.fitBounds(routeLayer.getBounds());

    // Hiển thị hướng dẫn từng bước
    const steps = (feat.properties?.segments?.[0]?.steps ?? []);
    let html = "<h3>Hướng dẫn</h3><ol>";
    steps.forEach(s => {
      html += `<li>${s.instruction} (${Math.round(s.distance)} m, ~${Math.round(s.duration/60)} phút)</li>`;
    });
    html += "</ol>";
    document.getElementById('steps').innerHTML = html;
  };
</script>
